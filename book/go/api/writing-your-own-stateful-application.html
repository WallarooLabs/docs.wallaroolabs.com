
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Writing Your Own Stateful Application · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-codetabs/codetabs.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="word-count.html" />
    
    
    <link rel="prev" href="writing-your-own-application.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../">
            
                <a href="../../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../what-is-wallaroo.html">
            
                <a href="../../what-is-wallaroo.html">
            
                    
                    What is Wallaroo?
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Core Concepts</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../core-concepts/intro.html">
            
                <a href="../../core-concepts/intro.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../core-concepts/core-concepts.html">
            
                <a href="../../core-concepts/core-concepts.html">
            
                    
                    Introducing Wallaroo Core Concepts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../core-concepts/state.html">
            
                <a href="../../core-concepts/state.html">
            
                    
                    State
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../core-concepts/working-with-state.html">
            
                <a href="../../core-concepts/working-with-state.html">
            
                    
                    Working with State
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../../core-concepts/partitioning.html">
            
                <a href="../../core-concepts/partitioning.html">
            
                    
                    Partitioning
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Wallaroo Language Support</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../language_support.html">
            
                <a href="../../language_support.html">
            
                    
                    Wallaroo Languages Supported
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Wallaroo with Python</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../../python/intro.html">
            
                <a href="../../python/intro.html">
            
                    
                    Wallaroo with Python Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../getting-started/setting-up-your-environment.html">
            
                <a href="../../getting-started/setting-up-your-environment.html">
            
                    
                    Setting up Your Environment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="../../getting-started/choosing-an-installation-option.html">
            
                <a href="../../getting-started/choosing-an-installation-option.html">
            
                    
                    Choosing an Installation Option
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="../../getting-started/installing-with-docker.html">
            
                <a href="../../getting-started/installing-with-docker.html">
            
                    
                    Installing with Docker
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.2.1" data-path="../../getting-started/docker-setup.html">
            
                <a href="../../getting-started/docker-setup.html">
            
                    
                    Setting Up Your Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2.2" data-path="../../getting-started/run-a-wallaroo-application-docker.html">
            
                <a href="../../getting-started/run-a-wallaroo-application-docker.html">
            
                    
                    Run a Wallaroo Application in Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="../../getting-started/installing-with-vagrant.html">
            
                <a href="../../getting-started/installing-with-vagrant.html">
            
                    
                    Installing with Vagrant
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.3.1" data-path="../../getting-started/vagrant-setup.html">
            
                <a href="../../getting-started/vagrant-setup.html">
            
                    
                    Setting Up Your Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3.2" data-path="../../getting-started/run-a-wallaroo-application-vagrant.html">
            
                <a href="../../getting-started/run-a-wallaroo-application-vagrant.html">
            
                    
                    Run a Wallaroo Application in Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="../../getting-started/installing-from-source.html">
            
                <a href="../../getting-started/installing-from-source.html">
            
                    
                    Installing From Source
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.4.1" data-path="../../getting-started/setup.html">
            
                <a href="../../getting-started/setup.html">
            
                    
                    Setting up Your Environment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.4.1.1" data-path="../../getting-started/linux-setup.html">
            
                <a href="../../getting-started/linux-setup.html">
            
                    
                    Ubuntu Installation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2.4.2" data-path="../../getting-started/run-a-wallaroo-application.html">
            
                <a href="../../getting-started/run-a-wallaroo-application.html">
            
                    
                    Run a Wallaroo Application
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2.5" data-path="../../getting-started/conclusion.html">
            
                <a href="../../getting-started/conclusion.html">
            
                    
                    Conclusion
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../../python/wallaroo-python-api.html">
            
                <a href="../../python/wallaroo-python-api.html">
            
                    
                    Wallaroo Python API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" data-path="../../python/running-a-wallaroo-python-application.html">
            
                <a href="../../python/running-a-wallaroo-python-application.html">
            
                    
                    Running a Wallaroo Python Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.2" data-path="../../python/writing-your-own-application.html">
            
                <a href="../../python/writing-your-own-application.html">
            
                    
                    Writing Your Own Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.3" data-path="../../python/writing-your-own-stateful-application.html">
            
                <a href="../../python/writing-your-own-stateful-application.html">
            
                    
                    Writing Your Own Stateful Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.4" data-path="../../python/writing-your-own-partitioned-stateful-application.html">
            
                <a href="../../python/writing-your-own-partitioned-stateful-application.html">
            
                    
                    Writing Your Own Partitioned Stateful Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.5" data-path="../../python/word-count.html">
            
                <a href="../../python/word-count.html">
            
                    
                    Word Count
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.6" data-path="../../python/interworker-serialization-and-resilience.html">
            
                <a href="../../python/interworker-serialization-and-resilience.html">
            
                    
                    Interworker Serialization and Resilience
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.7" data-path="../../python/api.html">
            
                <a href="../../python/api.html">
            
                    
                    Wallaroo Python API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" >
            
                <span>
            
                    
                    Debugging Python Wallaroo Applications
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.1" data-path="../../python/debugging.html">
            
                <a href="../../python/debugging.html">
            
                    
                    Debugging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Wallaroo with Go</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../intro.html">
            
                <a href="../intro.html">
            
                    
                    Go API Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../getting-started/setting-up-your-environment.html">
            
                <a href="../getting-started/setting-up-your-environment.html">
            
                    
                    Setting up Your Environment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.2.1" data-path="../getting-started/setup.html">
            
                <a href="../getting-started/setup.html">
            
                    
                    Setting up Your Environment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.2.1.1" data-path="../getting-started/linux-setup.html">
            
                <a href="../getting-started/linux-setup.html">
            
                    
                    Ubuntu Installation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.2.2" data-path="../getting-started/run-a-wallaroo-go-application.html">
            
                <a href="../getting-started/run-a-wallaroo-go-application.html">
            
                    
                    Run a Wallaroo Go Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.3" data-path="../getting-started/conclusion.html">
            
                <a href="../getting-started/conclusion.html">
            
                    
                    Conclusion
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="wallaroo-go-api.html">
            
                <a href="wallaroo-go-api.html">
            
                    
                    Wallaroo Go API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.3.1" data-path="writing-your-own-application.html">
            
                <a href="writing-your-own-application.html">
            
                    
                    Writing Your Own Application
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="5.3.2" data-path="writing-your-own-stateful-application.html">
            
                <a href="writing-your-own-stateful-application.html">
            
                    
                    Writing Your Own Stateful Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.3" data-path="word-count.html">
            
                <a href="word-count.html">
            
                    
                    Word Count
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.4" data-path="interworker-serialization-and-resilience.html">
            
                <a href="interworker-serialization-and-resilience.html">
            
                    
                    Interworker Serialization and Resilience
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.5" data-path="start-a-project.html">
            
                <a href="start-a-project.html">
            
                    
                    Start A Go Project
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.6" data-path="api.html">
            
                <a href="api.html">
            
                    
                    Wallaroo Go API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Running Wallaroo</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../../running-wallaroo/running-wallaroo.html">
            
                <a href="../../running-wallaroo/running-wallaroo.html">
            
                    
                    Running Wallaroo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../../running-wallaroo/autoscale.html">
            
                <a href="../../running-wallaroo/autoscale.html">
            
                    
                    Autoscale
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../../running-wallaroo/wallaroo-command-line-options.html">
            
                <a href="../../running-wallaroo/wallaroo-command-line-options.html">
            
                    
                    Command line options
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendix</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../../appendix/virtualenv.html">
            
                <a href="../../appendix/virtualenv.html">
            
                    
                    Wallaroo and Virtualenv
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="../../appendix/tcp-decoders-and-encoders.html">
            
                <a href="../../appendix/tcp-decoders-and-encoders.html">
            
                    
                    TCP Decoders and Encoders
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="../../wallaroo-tools/giles-sender.html">
            
                <a href="../../wallaroo-tools/giles-sender.html">
            
                    
                    Sending Data over TCP with Giles Sender
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.4" data-path="../../wallaroo-tools/giles-receiver.html">
            
                <a href="../../wallaroo-tools/giles-receiver.html">
            
                    
                    Receiving Data over TCP with Giles Receiver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.5" data-path="../../metrics/metrics-ui.html">
            
                <a href="../../metrics/metrics-ui.html">
            
                    
                    Monitoring Metrics with the Monitoring Hub
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.6" data-path="../../appendix/decoding-giles-receiver-output.html">
            
                <a href="../../appendix/decoding-giles-receiver-output.html">
            
                    
                    Decoding Giles Receiver Output
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.7" data-path="../../appendix/wallaroo-and-long-running-data-processing-and-other-workflows.html">
            
                <a href="../../appendix/wallaroo-and-long-running-data-processing-and-other-workflows.html">
            
                    
                    Wallaroo and Long-Running Data Processing and Other Workflows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.8" data-path="../../appendix/wallaroo-in-docker-tips.html">
            
                <a href="../../appendix/wallaroo-in-docker-tips.html">
            
                    
                    Tips for using Wallaroo in Docker
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Legal</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="../../legal/terms.html">
            
                <a href="../../legal/terms.html">
            
                    
                    Terms and Conditions
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../.." >Writing Your Own Stateful Application</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="writing-your-own-wallaroo-go-stateful-application">Writing Your Own Wallaroo Go Stateful Application</h1>
<p>In this section, we will go over how to write a stateful application with the Wallaroo Go API. If you haven&apos;t reviewed the simple stateless application example yet, you can find it <a href="writing-your-own-application.html">here</a>.</p>
<h2 id="a-stateful-application---alphabet">A Stateful Application - Alphabet</h2>
<p>Our stateful application is going to be a vote counter, called Alphabet. It receives as its input a message containing an alphabet character and a number of votes, which it then increments in its internal state. After each update, it sends the new updated vote count of that character to its output.</p>
<p>As with the Reverse Word example, we will list the components required:</p>
<ul>
<li>Input decoding</li>
<li>Output encoding</li>
<li>Computation for adding votes</li>
<li>State objects</li>
<li>State change management</li>
<li>A list of keys that are valid for partitioning our state objects</li>
<li>A partitioning function</li>
</ul>
<h3 id="state-computation">State Computation</h3>
<p>The state computation here is fairly straightforward: given a data object and a state object, update the state with the new data, and return some data that tells Wallaroo what to do next.</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> AddVotes <span class="hljs-keyword">struct</span> {}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(av *AddVotes)</span> <span class="hljs-title">Name</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;add votes&quot;</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(av *AddVotes)</span> <span class="hljs-title">Compute</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>{}, state <span class="hljs-keyword">interface</span>{})</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>{}, <span class="hljs-keyword">bool</span>)</span></span> {
  lv := data.(*LetterAndVotes)
  rvt := state.(*RunningVoteTotal)
  rvt.Update(lv)
  <span class="hljs-keyword">return</span> rvt.GetVotes(), <span class="hljs-literal">true</span>
}
</code></pre>
<p>Let&apos;s dig into our return values</p>
<pre><code class="lang-go"><span class="hljs-keyword">return</span> rvt.GetVotes(), <span class="hljs-literal">true</span>
</code></pre>
<p>The first element, <code>rvt.GetVotes()</code>, is a message that we will send on to our next step. In this case, we will be sending information about votes for this letter on to a sink. The second element, <code>true</code>, is to let Wallaroo know if we should store an update for our state. By returning <code>true</code>, we are instructing Wallaroo to save our updated state so that in the event of a crash, we can recover to this point. Being able to recover from a crash is a good thing, so why wouldn&apos;t we always return <code>true</code>? There are two answers:</p>
<ol>
<li>Your state computation might not have updated the state, in which case saving its state for recovery is wasteful.</li>
<li>You might only want to save after some changes. Saving your state can be expensive for large objects. There&apos;s a tradeoff that can be made between performance and safety.</li>
</ol>
<h3 id="state-and-statebuilder">State and StateBuilder</h3>
<p>We are going to partition by letter. We&apos;ll have a separate state object for every letter.</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> RunningVoteTotal <span class="hljs-keyword">struct</span> {
  Letter <span class="hljs-keyword">byte</span>
  Votes <span class="hljs-keyword">uint64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tv *RunningVoteTotal)</span> <span class="hljs-title">Update</span><span class="hljs-params">(votes *LetterAndVotes)</span></span> {
  tv.Letter = votes.Letter
  tv.Votes += votes.Votes
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tv *RunningVoteTotal)</span> <span class="hljs-title">GetVotes</span><span class="hljs-params">()</span> *<span class="hljs-title">LetterAndVotes</span></span> {
  <span class="hljs-keyword">return</span> &amp;LetterAndVotes{tv.Letter, tv.Votes}
}
</code></pre>
<p>Lastly, a stateful application&apos;s pipeline is going to need a <code>StateBuilder</code>, so let&apos;s create one:</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> RunningVotesTotalBuilder <span class="hljs-keyword">struct</span> {}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rvtb *RunningVotesTotalBuilder)</span> <span class="hljs-title">Build</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>{} {
  <span class="hljs-keyword">return</span> &amp;RunningVoteTotal{}
}
</code></pre>
<h3 id="encoder">Encoder</h3>
<p>By this point, we&apos;ve almost made it to the end of the line. The only thing left is the sink and encoding. We don&apos;t do anything fancy with our encoding. We take the letter and its vote count, and format it into a single line of text that our receiver can record.</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> Encoder <span class="hljs-keyword">struct</span> {}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(encoder *Encoder)</span> <span class="hljs-title">Encode</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>{})</span> []<span class="hljs-title">byte</span></span> {
  lav := data.(*LetterAndVotes)
  output := fmt.Sprintf(<span class="hljs-string">&quot;%s =&gt; %d\n&quot;</span>, <span class="hljs-keyword">string</span>(lav.Letter), lav.Votes)

  <span class="hljs-keyword">return</span> []<span class="hljs-keyword">byte</span>(output)
}
</code></pre>
<h3 id="decoder">Decoder</h3>
<p>The decoder, like the one in <a href="writing-your-own-application.html#sourcedecoder">Reverse Word</a>, is going to use a <code>HeaderLength()</code> of 4 bytes to denote a big-endian 32-bit unsigned integer. Then, for the data, it is expecting a single character followed by a big-endian 32-bit unsigned integer.</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> Decoder <span class="hljs-keyword">struct</span> {}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Decoder)</span> <span class="hljs-title">HeaderLength</span><span class="hljs-params">()</span> <span class="hljs-title">uint64</span></span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Decoder)</span> <span class="hljs-title">PayloadLength</span><span class="hljs-params">(b []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">uint64</span></span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">uint64</span>(binary.BigEndian.Uint32(b[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>]))
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Decoder)</span> <span class="hljs-title">Decode</span><span class="hljs-params">(b []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">interface</span></span>{} {
  letter := b[<span class="hljs-number">0</span>]
  vote_count := binary.BigEndian.Uint32(b[<span class="hljs-number">1</span>:])

  lav := LetterAndVotes{letter, <span class="hljs-keyword">uint64</span>(vote_count)}
  <span class="hljs-keyword">return</span> &amp;lav
}
</code></pre>
<h3 id="application-setup">Application Setup</h3>
<p>Finally, let&apos;s set up our application topology:</p>
<pre><code class="lang-go"><span class="hljs-comment">//export ApplicationSetup</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ApplicationSetup</span><span class="hljs-params">()</span> *<span class="hljs-title">C</span>.<span class="hljs-title">char</span></span> {
  fs := flag.NewFlagSet(<span class="hljs-string">&quot;wallaroo&quot;</span>, flag.ExitOnError)
  inHostsPortsArg := fs.String(<span class="hljs-string">&quot;in&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;input host:port list&quot;</span>)
  outHostsPortsArg := fs.String(<span class="hljs-string">&quot;out&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;output host:port list&quot;</span>)

  fs.Parse(wa.Args[<span class="hljs-number">1</span>:])

  inHostsPorts := hostsPortsToList(*inHostsPortsArg)

  inHost := inHostsPorts[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
  inPort := inHostsPorts[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]

  outHostsPorts := hostsPortsToList(*outHostsPortsArg)
  outHost := outHostsPorts[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
  outPort := outHostsPorts[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]

  wa.Serialize = Serialize
  wa.Deserialize = Deserialize

  application := app.MakeApplication(<span class="hljs-string">&quot;Alphabet&quot;</span>)
  application.NewPipeline(<span class="hljs-string">&quot;Alphabet&quot;</span>, app.MakeTCPSourceConfig(inHost, inPort, &amp;Decoder{})).
    ToStatePartition(&amp;AddVotes{}, &amp;RunningVotesTotalBuilder{}, <span class="hljs-string">&quot;running vote totals&quot;</span>, &amp;LetterPartitionFunction{}, MakeLetterPartitions()).
    ToSink(app.MakeTCPSinkConfig(outHost, outPort, &amp;Encoder{}))

  <span class="hljs-keyword">return</span> C.CString(application.ToJson())
}
</code></pre>
<p>The only difference between this setup and the stateless Reverse Word&apos;s one is that while in Reverse Word we used:</p>
<pre><code class="lang-go">To(&amp;ReverseBuilder{}).
</code></pre>
<p>here we use:</p>
<pre><code class="lang-go">ToStatePartition(&amp;AddVotes{}, &amp;RunningVotesTotalBuilder{}, <span class="hljs-string">&quot;running vote totals&quot;</span>, &amp;LetterPartitionFunction{}, MakeLetterPartitions()).
</code></pre>
<p>That is, while the stateless computation constructor <code>To</code> took only a computation class as its argument, the state computation constructor <code>ToStatePartition</code> takes a state computation <em>instance</em>, as well as a state-builder <em>instance</em>, along with the name of that state. Additionally, it takes two arguments needed for partitioning our state.</p>
<h2 id="partitioning">Partitioning</h2>
<p>Partitioning is a key aspect of how work is distributed in Wallaroo. From the application&apos;s point of view, what is required is:</p>
<ul>
<li>a list of partition keys</li>
<li>a partitioning function</li>
<li>partition-compatible states - the state should be defined in such a way that each partition can have its own distinct state instance</li>
</ul>
<h3 id="partition">Partition</h3>
<p>If we were to use partitioning in the alphabet application from the previous section and we wanted to partition by key, then one way we could go about it is to create a partition key list.</p>
<p>To create a partition key list, we use the <code>MakeLetterPartitions()</code> function:</p>
<pre><code class="lang-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MakeLetterPartitions</span><span class="hljs-params">()</span> []<span class="hljs-title">uint64</span></span> {
  letterPartition := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">uint64</span>, <span class="hljs-number">26</span>)

  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">26</span>; i++ {
    letterPartition[i] = <span class="hljs-keyword">uint64</span>(i + <span class="hljs-string">&apos;a&apos;</span>)
  }

  <span class="hljs-keyword">return</span> letterPartition
}
</code></pre>
<p>And then we define a partitioning function which returns a key from the above list for input data:</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> LetterPartitionFunction <span class="hljs-keyword">struct</span> {}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lpf *LetterPartitionFunction)</span> <span class="hljs-title">Partition</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>{})</span> <span class="hljs-title">uint64</span></span> {
  lav := data.(*LetterAndVotes)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">uint64</span>(lav.Letter)
}
</code></pre>
<p>When we set up our state partition, we pass both functions above as arguments to <code>ToStatePartition</code> as we saw earlier:</p>
<pre><code class="lang-go">ToStatePartition(&amp;AddVotes{}, &amp;RunningVotesTotalBuilder{}, <span class="hljs-string">&quot;running vote totals&quot;</span>, &amp;LetterPartitionFunction{}, MakeLetterPartitions()).
</code></pre>
<h2 id="next-steps">Next Steps</h2>
<p>The complete alphabet example is available <a href="https://github.com/WallarooLabs/wallaroo/tree/release-0.5.0/examples/go/alphabet/" target="_blank">here</a>. To run it, follow the <a href="https://github.com/WallarooLabs/wallaroo/tree/release-0.5.0/examples/go/alphabet/README.md" target="_blank">Alphabet application instructions</a></p>
<p>To see how everything we&apos;ve learned so far comes together, check out our <a href="word-count.html">Word Count walkthrough</a></p>
<p>Our Alphabet application contains serialization and deserialization code that we didn&apos;t cover; to learn more, skip ahead to <a href="interworker-serialization-and-resilience.html">Interworker Serialization and Resilience</a>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="writing-your-own-application.html" class="navigation navigation-prev " aria-label="Previous page: Writing Your Own Application">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="word-count.html" class="navigation navigation-next " aria-label="Next page: Word Count">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Writing Your Own Stateful Application","level":"5.3.2","depth":2,"next":{"title":"Word Count","level":"5.3.3","depth":2,"path":"book/go/api/word-count.md","ref":"book/go/api/word-count.md","articles":[]},"previous":{"title":"Writing Your Own Application","level":"5.3.1","depth":2,"path":"book/go/api/writing-your-own-application.md","ref":"book/go/api/writing-your-own-application.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["highlight","footnote-string-to-number","ga","codetabs"],"pluginsConfig":{"search":{},"codetabs":{},"footnote-string-to-number":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"ga":{"configuration":"auto","token":"UA-59652249-3"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"intro.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"footerTemplate":"©2017 All Rights Reserved, Wallaroo Labs"},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"book/go/api/writing-your-own-stateful-application.md","mtime":"2018-07-17T16:38:30.630Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-07-17T16:38:42.261Z"},"basePath":"../../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../../gitbook/gitbook.js"></script>
    <script src="../../../gitbook/theme.js"></script>
    
        
        <script src="../../../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-codetabs/codetabs.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

